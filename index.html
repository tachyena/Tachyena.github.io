<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="google7217b3ac0ba5fa61.html">
    <title>智泊云 - 智能停车场优化系统</title>
    <!-- 高德地图JS API，使用您的密钥 -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=2a3543776c048b0253b10252fa8c3356"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 2vw;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #fff;
            padding: 2vw;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 2vh;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }
        #map {
            height: 60vh;
            width: 100%;
            margin-top: 2vh;
            border-radius: 8px;
            background: #ddd; /* 若地图加载失败，显示灰色背景 */
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 2vh 0;
            gap: 1vw;
        }
        select, .button {
            padding: 1vw;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            width: clamp(100px, 20vw, 200px);
            font-size: clamp(0.8rem, 2.5vw, 1rem);
        }
        .button:hover, select:hover {
            background: #2980b9;
        }
        .error-message {
            text-align: center;
            color: red;
            margin-top: 1vh;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>智泊云 - 智能停车场优化系统</h1>
        <div class="controls">
            <select id="parking-select">
                <option value="">选择停车场</option>
            </select>
            <a href="#" class="button" id="navigate-btn">导航至选中车位</a>
        </div>
        <div id="map"></div>
        <div id="error-message" class="error-message"></div>
    </div>

    <script>
        // 模拟停车场数据（武汉集中）
        const parkingLots = [
            { id: 1, name: "北京停车场A", lnglat: [116.397428, 39.90923], spaces: 50, occupied: 30 },
            { id: 2, name: "上海停车场B", lnglat: [121.473701, 31.230416], spaces: 40, occupied: 25 },
            { id: 3, name: "武汉停车场D", lnglat: [114.305392, 30.593099], spaces: 60, occupied: 40 },
            { id: 4, name: "武汉停车场E", lnglat: [114.300000, 30.595000], spaces: 50, occupied: 20 }
        ];

        let map = null;
        let userPosition = null;
        let selectedParking = null;

        // 检查API是否加载
        function checkAMapLoaded() {
            return new Promise((resolve, reject) => {
                if (typeof AMap !== 'undefined') {
                    resolve();
                } else {
                    let script = document.createElement('script');
                    script.src = 'https://webapi.amap.com/maps?v=2.0&key=2a3543776c048b0253b10252fa8c3356';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('高德地图API加载失败'));
                    document.head.appendChild(script);
                }
            });
        }

        // 初始化地图
        async function initMap() {
            const errorDiv = document.getElementById('error-message');
            try {
                await checkAMapLoaded();

                map = new AMap.Map('map', {
                    zoom: 4,
                    center: [104.195397, 35.86166],
                    resizeEnable: true,
                    mapStyle: 'amap://styles/normal',
                    features: ['bg', 'road', 'point'],
                    viewMode: '2D',
                    showLabel: true
                });

                // 添加停车场标记和下拉菜单
                const parkingSelect = document.getElementById('parking-select');
                parkingLots.forEach(lot => {
                    let marker = new AMap.Marker({
                        position: lot.lnglat,
                        title: lot.name,
                        map: map,
                        label: { content: `${lot.name} (${lot.spaces - lot.occupied}空位)`, offset: new AMap.Pixel(10, -10) }
                    });
                    marker.on('click', () => {
                        selectedParking = lot;
                        map.setCenter(lot.lnglat);
                        map.setZoom(15);
                    });
                    let option = document.createElement('option');
                    option.value = lot.id;
                    option.textContent = `${lot.name} (${lot.spaces - lot.occupied}空位)`;
                    parkingSelect.appendChild(option);
                });

                // 停车场选择
                parkingSelect.addEventListener('change', (e) => {
                    const id = parseInt(e.target.value);
                    selectedParking = parkingLots.find(lot => lot.id === id) || null;
                    if (selectedParking) {
                        map.setCenter(selectedParking.lnglat);
                        map.setZoom(15);
                    }
                });

                // 获取用户位置
                AMap.plugin('AMap.Geolocation', function() {
                    let geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 10000,
                        buttonOffset: new AMap.Pixel(10, 20),
                        zoomToAccuracy: true
                    });
                    map.addControl(geolocation);
                    geolocation.getCurrentPosition(function(status, result) {
                        if (status === 'complete') {
                            userPosition = result.position;
                            let marker = new AMap.Marker({
                                position: userPosition,
                                map: map,
                                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                                title: '您的位置'
                            });
                            map.setCenter(userPosition);
                            map.setZoom(15);
                        } else {
                            console.error('定位失败:', result.message);
                        }
                    });
                });

                // 导航功能
                document.getElementById('navigate-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!userPosition || !selectedParking) {
                        alert('请先定位并选择停车场！');
                        return;
                    }
                    AMap.plugin('AMap.Driving', function() {
                        let driving = new AMap.Driving({ map: map });
                        driving.search(userPosition, selectedParking.lnglat, function(status, result) {
                            if (status !== 'complete') {
                                alert('导航失败: ' + result);
                            }
                        });
                    });
                });

                errorDiv.textContent = ''; // 加载成功，清除错误信息
            } catch (error) {
                console.error('地图初始化失败:', error);
                errorDiv.textContent = '地图加载失败: ' + error.message + '。请检查网络或运行环境。';
            }
        }

        // 运行初始化
        window.onload = function() {
            if (window.location.protocol === 'file:') {
                document.getElementById('error-message').textContent = '请通过本地服务器运行（如Live Server），不支持file://协议';
            } else {
                initMap();
            }
        };
    </script>
</body>
</html>
