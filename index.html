<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="google7217b3ac0ba5fa61.html">
    <title>智泊云 - 智能停车场优化系统</title>
    <!-- 高德地图JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_SERVER_SIDE_API_KEY"></script>
    <style>
        /* 省略样式部分 */
    </style>
</head>
<body>
    <div class="container">
        <h1>智泊云 - 智能停车场优化系统</h1>
        <div class="status-box">
            <div class="status-item">
                <h3>可用车位</h3>
                <p id="available-spaces">0</p>
            </div>
            <div class="status-item">
                <h3>预测需求</h3>
                <p id="predicted-demand">0</p>
            </div>
            <div class="status-item">
                <h3>占用率</h3>
                <p id="occupancy-rate">0%</p>
            </div>
            <div class="status-item">
                <h3>交通状况</h3>
                <p id="traffic-status">未知</p>
            </div>
        </div>
        <div class="controls">
            <select id="district-select">
                <option value="中国">全国</option>
            </select>
            <input type="text" id="city-search" placeholder="输入城市名称搜索">
            <select id="parking-select">
                <option value="">选择停车场</option>
            </select>
            <a href="#" class="button" id="navigate-btn">导航至选中车位</a>
        </div>
        <div id="map"></div>
        <div id="panel"></div>
        <p class="update-time">最后更新: <span id="last-update">加载中...</span></p>
    </div>

    <script>
        // 等待DOM加载完成
        window.onload = function() {
            let map = new AMap.Map('map', {
                zoom: 4,
                center: [104.195397, 35.86166],
                resizeEnable: true,
                mapStyle: 'amap://styles/normal',
                features: ['bg', 'road', 'building', 'point'],
                viewMode: '2D',
                showLabel: true
            });

            // 添加地图控件
            map.plugin(['AMap.ToolBar', 'AMap.Scale', 'AMap.Traffic'], function() {
                map.addControl(new AMap.ToolBar());
                map.addControl(new AMap.Scale());
                let trafficLayer = new AMap.Traffic({ autoRefresh: true });
                map.add(trafficLayer);
            });

            const provinces = {
                "11": { name: "北京市", cities: { "1101": "北京市" } },
                // ... 省略其他省份数据 ...
            };

            const parkingLots = [
                { id: 1, name: "北京停车场A", lnglat: [116.397428, 39.90923], spaces: 50, occupied: 30 },
                // ... 省略其他停车场数据 ...
            ];

            let userPosition = null;
            let selectedParking = null;

            // 添加停车场标记和下拉菜单
            const parkingSelect = document.getElementById('parking-select');
            parkingLots.forEach(lot => {
                let marker = new AMap.Marker({
                    position: lot.lnglat,
                    title: lot.name,
                    map: map,
                    label: { content: `${lot.name} (${lot.spaces - lot.occupied}空位)`, offset: new AMap.Pixel(10, -10) }
                });
                marker.on('click', () => {
                    selectedParking = lot;
                    showParkingInfo(lot);
                    map.setCenter(lot.lnglat);
                    map.setZoom(15);
                });
                let option = document.createElement('option');
                option.value = lot.id;
                option.textContent = `${lot.name} (${lot.spaces - lot.occupied}空位)`;
                parkingSelect.appendChild(option);
            });

            // 行政区划选择
            const districtSelect = document.getElementById('district-select');
            Object.keys(provinces).forEach(adcode => {
                let option = document.createElement('option');
                option.value = adcode;
                option.textContent = provinces[adcode].name;
                districtSelect.appendChild(option);
            });

            districtSelect.addEventListener('change', (e) => {
                let adcode = e.target.value;
                if (adcode === '中国') {
                    map.setZoomAndCenter(4, [104.195397, 35.86166]);
                    clearDistrict();
                    while (districtSelect.options.length > 1) districtSelect.remove(1);
                    Object.keys(provinces).forEach(code => {
                        let opt = document.createElement('option');
                        opt.value = code;
                        opt.textContent = provinces[code].name;
                        districtSelect.appendChild(opt);
                    });
                    return;
                }

                AMap.plugin('AMap.DistrictSearch', function() {
                    let district = new AMap.DistrictSearch({
                        level: adcode.length === 2 ? 'province' : 'city',
                        subdistrict: 0
                    });
                    district.search(adcode, function(status, result) {
                        if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                            clearDistrict();
                            let districtData = result.districtList[0];
                            let bounds = districtData.boundaries;
                            let polygons = [];
                            if (bounds) {
                                bounds.forEach(bound => {
                                    let polygon = new AMap.Polygon({
                                        path: bound,
                                        fillColor: '#80d8ff',
                                        fillOpacity: 0.4,
                                        strokeColor: '#0091ea',
                                        strokeWeight: 3
                                    });
                                    polygons.push(polygon);
                                    map.add(polygon);
                                });
                                map.setFitView(polygons);
                            } else {
                                map.setCenter(districtData.center);
                                map.setZoom(10);
                            }

                            while (districtSelect.options.length > 1) districtSelect.remove(1);
                            let cities = provinces[adcode].cities || {};
                            Object.keys(cities).forEach(cityCode => {
                                let opt = document.createElement('option');
                                opt.value = cityCode;
                                opt.textContent = cities[cityCode];
                                districtSelect.appendChild(opt);
                            });
                        } else {
                            console.error('行政区划查询失败:', result);
                        }
                    });
                });
            });

            // 城市搜索栏
            const citySearch = document.getElementById('city-search');
            AMap.plugin('AMap.AutoComplete', function() {
                let autoComplete = new AMap.AutoComplete({ city: '全国' });
                citySearch.addEventListener('input', (e) => {
                    autoComplete.search(e.target.value, function(status, result) {
                        if (status === 'complete' && result.tips && result.tips.length > 0) {
                            let tip = result.tips[0];
                            map.setCenter(tip.location);
                            map.setZoom(12);
                            clearDistrict();
                        }
                    });
                });
            });

            // 清除行政区划覆盖物
            function clearDistrict() {
                map.getAllOverlays('polygon').forEach(polygon => map.remove(polygon));
            }

            // 停车场选择
            parkingSelect.addEventListener('change', (e) => {
                const id = parseInt(e.target.value);
                selectedParking = parkingLots.find(lot => lot.id === id) || null;
                if (selectedParking) {
                    map.setCenter(selectedParking.lnglat);
                    map.setZoom(15);
                    showParkingInfo(selectedParking);
                }
            });

            // 获取用户位置
            AMap.plugin('AMap.Geolocation', function() {
                let geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    buttonOffset: new AMap.Pixel(10, 20),
                    zoomToAccuracy: true
                });
                map.addControl(geolocation);
                geolocation.getCurrentPosition(function(status, result) {
                    if (status === 'complete') {
                        userPosition = result.position;
                        let marker = new AMap.Marker({
                            position: userPosition,
                            map: map,
                            icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                            title: '您的位置'
                        });
                        map.setCenter(userPosition);
                        map.setZoom(15);
                        updateParkingStatus();
                    } else {
                        alert('定位失败，请检查网络连接或设备权限。');
                        console.error('定位失败:', result.message);
                    }
                });
            });

            // 更新停车状态
            function updateParkingStatus() {
                let totalSpaces = parkingLots.reduce((sum, lot) => sum + lot.spaces, 0);
                let totalOccupied = parkingLots.reduce((sum, lot) => sum + lot.occupied, 0);
                let available = totalSpaces - totalOccupied;
                let occupancyRate = totalOccupied > 0 ? (totalOccupied / totalSpaces * 100).toFixed(1) : 0;

                document.getElementById('available-spaces').textContent = available;
                document.getElementById('predicted-demand').textContent = Math.floor(Math.random() * totalSpaces * 0.5);
                document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
                document.getElementById('traffic-status').textContent = available > totalSpaces * 0.2 ? '畅通' : '拥堵';

                let now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleString('zh-CN');
            }

            // 显示停车场信息
            function showParkingInfo(lot) {
                let infoWindow = new AMap.InfoWindow({
                    content: `<h4>${lot.name}</h4><p>可用车位: ${lot.spaces - lot.occupied}</p><p>总车位: ${lot.spaces}</p><p>经纬度: ${lot.lnglat}</p>`,
                    offset: new AMap.Pixel(0, -30)
                });
                infoWindow.open(map, lot.lnglat);
            }

            // 导航功能
            document.getElementById('navigate-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (!userPosition) {
                    alert('请先获取您的位置！');
                    return;
                }
                if (!selectedParking) {
                    alert('请从下拉菜单选择一个停车场！');
                    return;
                }
                if (selectedParking.spaces - selectedParking.occupied <= 0) {
                    alert('所选停车场无可用车位，请选择其他停车场。');
                    return;
                }

                AMap.plugin('AMap.Driving', function() {
                    let driving = new AMap.Driving({
                        map: map,
                        panel: 'panel',
                        policy: AMap.DrivingPolicy.LEAST_TIME
                    });
                    driving.search(userPosition, selectedParking.lnglat, function(status, result) {
                        if (status === 'complete') {
                            document.getElementById('panel').style.display = 'block';
                            alert(`导航已规划，从当前位置到${selectedParking.name}，请查看路线详情！`);
                        } else {
                            alert('导航规划失败: ' + result);
                        }
                    });
                });
            });

            // 初始化状态并定时更新
            updateParkingStatus();
            setInterval(updateParkingStatus, 10000); // 调整更新频率为10秒
        };
    </script>
</body>
</html>
